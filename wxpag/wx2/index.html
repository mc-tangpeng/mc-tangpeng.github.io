<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=640, user-scalable=no, target-densityDpi=device-dpi" >
	<title>Document</title>
	<style type="text/css">
	*{margin: 0;padding: 0}
	html {overflow: hidden;}
	body{ font-family:Tahoma,Arial,Roboto,"Droid Sans","Helvetica Neue","Droid Sans Fallback","Heiti SC",sans-self;}
	li{ list-style:none;}
	#main {position:relative;width: 100%;height: auto;overflow: hidden;}
	#list {}
	#list > li {position:absolute;left:0;top:0;width: 100%;height: 100%;background-size: cover;background-repeat: no-repeat;z-index: 5;display: none;}
	#list > li.active {z-index: 6}
	#list > li:nth-of-type(1) {background-image: url(img/b.png);display: block;}  /*这里必须是-image，不然会把上面的background的属性给覆盖掉*/
	#list > li:nth-of-type(2) {background-image: url(img/c.png);}  
	#list > li:nth-of-type(3) {background-image: url(img/d.png);}  
	#list > li:nth-of-type(4) {background-image: url(img/e.png);} 
	#list > li:nth-of-type(5) {background-image: url(img/ad1.png);}  
	#list > li:nth-of-type(6) {background-image: url(img/ad2.png);}  
	#list > li:nth-of-type(7) {background-image: url(img/ad3.png);} 
	#list > li:nth-of-type(8) {background-image: url(img/ad4.png);} 
	#list .conten1 {position: absolute;left: 20%;top: 62%}
	#list .conten1 p {font-size: 30px;color: #fff}
	#list .li2child li {width:90px; height:90px; position:absolute;}
	#list .li2child li:nth-of-type(1){ background:url(img/c1.png); left:43% ; top:30%;}
	#list .li2child li:nth-of-type(2){ background:url(img/c2.png); left:13% ; top:40%;}
	#list .li2child li:nth-of-type(3){ background:url(img/c3.png); left:73% ; top:40%;}
	#list .li2child li:nth-of-type(4){ background:url(img/c4.png); left:13% ; top:65%;}
	#list .li2child li:nth-of-type(5){ background:url(img/c5.png); left:73% ; top:65%;}
	#list .li2child li:nth-of-type(6){ background:url(img/c6.png); left:43% ; top:75%;}
	#list .li2child li.active{ left:43%; top:52%;}
	#list .li3child {position:absolute; left:50%;top:60%;margin-left:-230px;width: 460px;height: 222px;background: url(img/d1.png) no-repeat}

	#list .li4child li{ font-size:22px; color:white; border:1px #FFF solid; box-shadow:0 0 15px #FFF; border-radius:5px; word-wrap:break-word; position:absolute; overflow:hidden;}
	#list .li4child li:nth-of-type(1){ width:220px; height:240px; left:4%; top:15%;}
	#list .li4child li:nth-of-type(2){ width:280px; height:150px; left:50%; top:19%;}
	#list .li4child li:nth-of-type(3){ width:110px; height:280px; left:78%; top:40%;}
	#list .li4child li.active{ width:0; height:0;}

	#c1 {position: absolute;left: 0;top: 0;z-index: 10;width: 100%;height: 100%;}
	#arrow {position:absolute;z-index:7; left:50%; bottom:20px;margin-left:-45px;width: 90px; height: 52px;background: url(img/arr.png) no-repeat;-webkit-animation:1s infinite arrow;animation:1s infinite arrow;}
	@-webkit-keyframes arrow{
		0%{opacity: 0;-webkit-transform: translate(0,0);}
		50%{opacity: 1;-webkit-transform: translate(0,-30px);}
		100%{opacity: 0;-webkit-transform: translate(0,-40px);}
	}
	@keyframes arrow{
		0%{opacity: 0;-webkit-transform: translate(0,0);}
		50%{opacity: 1;-webkit-transform: translate(0,-30px);}
		100%{opacity: 0;-webkit-transform: translate(0,-40px);}
	}
	#music {position: absolute;right: 20px;top: 20px;z-index: 7;width: 50px;height: 50px;background:url(img/music.png) no-repeat;background-size: cover;}
	#music.active{-webkit-animation:1s infinite music linear;animation:1s infinite music linear;}
	@-webkit-keyframes music{
		0%{-webkit-transform: rotate(0);}
		100%{-webkit-transform: rotate(360deg);}
	}
	@keyframes music{
		0%{transform: rotate(0);}
		100%{transform: rotate(360deg);}
	}
	#loading {position: absolute;left: 0;top: 0;z-index:20;width: 100%;height: 100%;background:#000;}
	#loading ul {position: absolute;left: 50%;top: 40%;margin-left: -45px;}
	#loading ul li {width: 5px;height: 40px;background: #0cf; float:left; margin-right:10px;-webkit-animation:2s infinite loading linear;animation:2s infinite loading linear;}
	@-webkit-keyframes loading{
		0%{ -webkit-transform:scaleY(1);}
		50%{ -webkit-transform : scale(0.1);}
		100%{ -webkit-transform:scaleY(1);}
	}
	@keyframes loading{
		0%{ transform:scaleY(1);}
		50%{ transform : scale(0.1);}
		100%{ transform:scaleY(1);}
	}
	#loading ul li:nth-of-type(1){
	
	}
	#loading ul li:nth-of-type(2){
		-webkit-animation-delay : -0.2s;
	}
	#loading ul li:nth-of-type(3){
		-webkit-animation-delay : -0.4s;
	}
	#loading ul li:nth-of-type(4){
		-webkit-animation-delay : -0.6s;
	}
	#loading ul li:nth-of-type(5){
		-webkit-animation-delay : -0.8s;
	}
	#loading ul li:nth-of-type(6){
		-webkit-animation-delay : -1s;
	}
	</style>
	<script src="jquery-2.1.3.min.js"></script>
	<script type="text/javascript">
	$(document).on('touchmove touchend',function(ev){
		ev.preventDefault();
	});
	$(function(){
		var $main = $('#main');
		var $list = $('#list');
		var $li = $list.find('>li');
		var viewHeight = $(window).height();
		$main.height(viewHeight);
		$li.css('backgroundPosition',''+(640-viewWidth())/2+'px 0')

		showLoading()
		slideCanvas()
		
		function slideCanvas() {  //刮开的canvas
			var $c1 = $('#c1');
			var gc = $c1.get(0).getContext('2d');
			var bBtn = true;
			var oImg = new Image();
			oImg.src = 'img/a.png';
			$c1.attr('height',viewHeight)  //不是设置height会使图片变形
			oImg.onload = function() {
				gc.drawImage(oImg,(640-viewWidth())/2,0,viewWidth(),viewHeight);
				// gc.fillStyle = 'blue'; 要使用边框而不是填充
				gc.strokeStyle = 'blue';
				gc.lineWidth = 60;
				gc.lineCap = 'round';
				gc.globalCompositeOperation = 'destination-out';

				$c1.on('touchstart',function(ev) {
					var touch = ev.originalEvent.changedTouches[0];
					var x = touch.pageX - $c1.offset().left;
					var y = touch.pageY - $c1.offset().top;
					if (bBtn) {  //仅走一次
						gc.moveTo(x,y);
						gc.lineTo(x+1,y+1);
						bBtn = false;

					}else {
						gc.lineTo(x+1,y+1);
					}
					gc.stroke();
					$c1.on('touchmove.c1',function(ev) {
						var touch = ev.originalEvent.changedTouches[0];
						var x = touch.pageX - $c1.offset().left;
						var y = touch.pageY - $c1.offset().top;
						gc.lineTo(x,y);
						gc.stroke();
					});
					$c1.on('touchend.c1',function() {
						var imgData = gc.getImageData(0,0,640,viewHeight);
						var allPx = imgData.width * imgData.height;
						var num = 0;
						for (var i = 0; i < allPx; i++) {
							if(imgData.data[4*i+3] == 0){
								num++;
							}
						};

						if (num > allPx/2) {
							$c1.animate({'opacity' : 0},1000,function() {
								$(this).remove();
								slideImg()
								cjAnimate[0].inAn()
							})
							showMusic()
						};
						
						$c1.off('.c1')
					})
				})
				
			}
		}
		function slideImg() {  //滑动每一页
			var step = 1/4;
			var startY = 0;
			var nowIndex = 0;
			var prevornextIndex = 0;
			var bBtn = true;
			$li.on('touchstart',function(ev) {
				if (bBtn) {
					bBtn = false;
					var touch = ev.originalEvent.changedTouches[0];
					startY = touch.pageY;
					nowIndex = $(this).index();
					// $li.eq(nowIndex).sliblings().hide();
					$(this).siblings().hide();
					$li.on('touchmove.li',function(ev) {
						var touch = ev.originalEvent.changedTouches[0];
						if (touch.pageY < startY) { //↑
							prevornextIndex = nowIndex == $li.length-1 ? 0 : nowIndex + 1;
							$li.eq(prevornextIndex).css({'transform' : 'translate(0,'+( viewHeight + touch.pageY - startY)+'px)'}).show()
							
						} else if (touch.pageY > startY) { //↓
							prevornextIndex = nowIndex == 0 ? $li.length-1 : nowIndex - 1;
							$li.eq(prevornextIndex).css({'transform' : 'translate(0,'+( -viewHeight + touch.pageY - startY)+'px)'}).show()
						}
						$(this).css({'transform' : 'translate(0,'+(touch.pageY - startY)+'px) scale('+(1-Math.abs(touch.pageY - startY)*step/viewHeight)+')'});
						$li.eq(prevornextIndex).attr('class','active').siblings().attr('class','')
					})
					$li.on('touchend.li',function(ev) {
						var touch = ev.originalEvent.changedTouches[0];
						if (touch.pageY < startY) { //↑
							$li.eq(nowIndex).css('transform','translate(0,'+(-viewHeight * step)+'px) scale('+(1 - step)+')');
							
							
						} else if (touch.pageY > startY) { //↓
							$li.eq(nowIndex).css('transform','translate(0,'+(viewHeight * step)+'px) scale('+(1 - step)+')');
							
						} else if(touch.pageY == startY) { //当两只相等时，如不做处理，则会执行resetFn();
							bBtn= true;
							return;
							
						}
						$li.eq(nowIndex).css({'opacity':0,'transition' : '.3s'})
						$li.eq(prevornextIndex).css({'transform' : 'translate(0,0)','transition' : '.3s'})
						$li.off('.li')
					})
				}
			})
			$li.on('webkitTransitionEnd transitionEnd',function(ev) { //结束后
				if(!$li.is(ev.target)){return}
					console.log('还是执行了')
				resetFn();
				if (cjAnimate[prevornextIndex]) {
					cjAnimate[prevornextIndex].inAn()
				};
				if (cjAnimate[nowIndex]) {
					cjAnimate[nowIndex].outAn()
				};
				
			})
			function resetFn() {  //必须重置，不然会抖动
				$li.css('transform','');
				$li.css('transition','');
				$li.css('opacity',1);
				// $li.eq(prevornextIndex).removeClass('active').siblings().removeClass('active').hide(); 在move的时候已经算重置了，
				bBtn = true;
			}
		}
		function viewWidth() {
			var w = 640*viewHeight/960;
			w = w > 640 ? w : 640;
			return w;
		}
		var cjAnimate = [
			{
				inAn : function() {
					var $p = $li.eq(0).find('p');
					setTimeout(function(){
						$p.css({'transform':'translate(0,0)','transition' : '1s','opacity' : 1} )
					},100)
				},
				outAn : function() {
					var $p = $li.eq(0).find('p');
					$p.css({'transition' : '','opacity' : 0})
					$p.filter(':even').css('transform','translate(300px,0)');
					$p.filter(':odd').css('transform','translate(-200px,0)');
				}
			},
			{
				inAn : function() {
					var $liChild = $li.eq(1).find('li');
					setTimeout(function(){
						$liChild.removeClass('active').css({'opacity' : 1, 'transition' : '1s', 'transform' : 'rotate(720deg)' })
					},100)
				},
				outAn : function() {
					var $liChild = $li.eq(1).find('li');
					$liChild.attr('class','active').css({'opacity' : 0, 'transition' : '', 'transform' : 'rotate(0deg)' })
				}
			},
			{
				inAn : function() {
					var $liChild = $li.eq(2).find('div');
					setTimeout(function(){
						$liChild.css({'opacity' : 1, 'transition' : '1s', 'transform' : 'rotateY(0deg)' })
					},100)
				},
				outAn : function() {
					var $liChild = $li.eq(2).find('div');
					$liChild.css({'opacity' : 0, 'transition' : '', 'transform' : 'rotateY(360deg)' })
				}
			},
			{
				inAn : function() {
					var $liChild = $li.eq(3).find('li');
					setTimeout(function(){
						$liChild.attr('class','').css({'transition' : '1s'})
					},100)
				},
				outAn : function() {
					var $liChild = $li.eq(3).find('li');
					$liChild.attr('class','active').css({'transition' : ''})
				}
			}
		]
		$.each(cjAnimate,function(i,cj){
			cjAnimate[i].outAn()
		
		})
		function showMusic() {
			var $m = $('#music');
			var $a1 = $('#a1');
			var onoff = true;
			$m.on('touchstart',function() {
				if (onoff) {  //on
					$m.attr('class','active');
					$a1.get(0).play();
				}else { //off
					$m.removeClass('active');
					$a1.get(0).pause();

				}
				onoff = !onoff;
			})
			$m.trigger('touchstart')
		}
		function showLoading() {
			var arr = ['a.png','b.png','c.png','d.png','e.png','ad1.png','ad2.png','ad3.png','ad4.png','c1.png','c2.png','c3.png','c4.png','c5.png','c6.png'];
			var num = 0;
			$.each(arr,function(i,imgsrc) {
				var oImg = new Image();
				oImg.src = 'img/'+arr[i];
				oImg.onload = function() {
					num++;
					if (num == arr.length) {
						$('#loading').animate({'opacity' : 0},1000,function(){
							$(this).remove();
							
						})
					};
				}
				oImg.onerror = function() {
					$('#loading').animate({'opacity' : 0},1000,function(){
						$(this).remove();
						
					})
				}
			})
		}
	})
	</script>
</head>
<body>
	<div id="main">
		<div id="loading">
				<ul>
			    	<li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			    </ul>
		</div>
		<canvas id="c1" width="640" height="960"></canvas>
		<ul id="list">
			<li>
				<div class="conten1">
					<p>曾经做为前端开发的你</p>
					<p>解决PC兼容性而焦头烂额</p>
					<p>而今</p>
					<p>移动端H5应用疯狂来袭</p>
					<p>你是否已准备充分</p>
					<p>学习新技能</p>
					<p>曾破茧成蝶、重获新生？</p>
				</div>
			</li>
			<li>
				<ul class="li2child">
			    	<li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			        <li></li>
			    </ul>
			</li>
			<li>
				<div class="li3child"></div>
			</li>
			<li>
				<ul class="li4child">
			    	<li>transform  transition  rotate  scale  translate  keyframes animation  webkitTransitionEnd webkitAnimationIteration elapsedTime perspective…</li>
			        <li>drawImage lineWidth  strokeStyle  lineCap  globalCompositeOperation  moveTo   lineTo  stroke  arc  getImageData…</li>
			        <li>audio autoplay loop  paused  play  pause…</li>
			    </ul>
			</li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
		</ul>
		<div id="arrow"></div>
		<div id="music">
			<audio id="a1" src="img/music.mp3" preload="auto" loop></audio>
		</div>
	</div>
</body>
</html>